# Discogs Tagger - Project Context

## Overview
A local web-based music manager and tagger inspired by MusicBee. Uses the Discogs API to fetch accurate metadata and apply ID3 tags to MP3 files. Built with CodeIgniter 4 framework and Bootstrap 5 for a modern, responsive UI.

## Purpose
- **Browse** a local music library with hierarchical grouping by Album Artist
- **Organize** albums by artist with automatic year-based sorting (MusicBee-style)
- **Search** Discogs database for accurate album metadata
- **Preview** tag changes before applying
- **Tag** MP3 files with album artist, title, year, genre, publisher, and track numbers
- **Smart Features**: Automatically merge split releases, clean artist names, intelligent caching

## Tech Stack

### Backend
- **Framework**: CodeIgniter 4
- **PHP**: 8.1+
- **Libraries**:
  - `james-heinrich/getid3`: Read/write ID3 tags from MP3 files
  - `guzzlehttp/guzzle`: HTTP client for Discogs API calls
  - `vlucas/phpdotenv`: Environment variable management

### Frontend
- **Bootstrap 5**: UI framework with dark/light theme support
- **Vanilla JavaScript**: No frontend frameworks required
- **Bootstrap Icons**: Icon library

### APIs
- **Discogs API**: Release metadata, artist info, labels/publishers
  - Rate limiting: 60 requests/minute (unauthenticated)
  - Requires consumer key/secret in `.env`

## Project Structure

```
discogs_tagger/
├── ci4/                          # CodeIgniter 4 application
│   ├── app/
│   │   ├── Config/               # CI4 configuration
│   │   │   └── Routes.php        # API route definitions
│   │   ├── Controllers/
│   │   │   ├── Api/              # API controllers
│   │   │   │   ├── Scan.php      # File scanning endpoints
│   │   │   │   ├── Search.php    # Discogs search endpoints
│   │   │   │   └── Tag.php       # Tag writing endpoints
│   │   │   └── Home.php          # Main view controller
│   │   ├── Libraries/            # Core business logic
│   │   │   ├── FileScanner.php   # Directory/file scanning
│   │   │   ├── TagManager.php    # ID3 tag read/write
│   │   │   └── DiscogsService.php # Discogs API integration
│   │   └── Views/
│   │       └── home.php          # Single-page application view
│   ├── public/
│   │   ├── js/
│   │   │   └── app.js            # Frontend SPA logic
│   │   ├── css/
│   │   │   └── style.css         # Custom styles
│   │   └── assets/               # Images, default cover
│   ├── vendor/                   # Composer dependencies
│   └── .env                      # Environment configuration
├── start_server.bat              # Quick server startup script
├── README.md                     # User-facing documentation
└── .context.md                   # This file

```

## Key Components

### FileScanner (`ci4/app/Libraries/FileScanner.php`)
- **Purpose**: Scan music directory recursively with metadata caching
- **Key Methods**:
  - `getAlbums()`: Recursively find all album folders, return flattened list
  - `getAlbumsWithMetadata($path, $forceRefresh)`: **NEW** Extract ID3 metadata with caching
  - `loadCache()`: **NEW** Load cached metadata from `library_cache.json`
  - `saveCache($albums)`: **NEW** Save metadata to cache file
  - `getCacheFilePath()`: **NEW** Get cache file location
  - `scanForAlbums()`: Helper for recursive traversal
  - `createAlbumNode()`: Extract metadata from first file in folder
  - `getCover()`: Get cover art (prioritizes local `cover.jpg`/`folder.jpg`, falls back to ID3 tags)
  - `getTracks()`: Get all music files in a folder with metadata

**Caching System** (NEW):
- **Cache File**: `library_cache.json` in music root directory
- **Cache Duration**: 24 hours (auto-expires)
- **Cache Content**: Album artist, year, album title, path, cover flag
- **Performance**: First load 2-5s, subsequent loads <1s
- **Force Refresh**: Available via `force=1` query parameter

**Optimization Notes**:
- Avoids OOM errors by returning `cover: null` for album lists
- Uses lazy loading for cover images via API endpoint
- Checks for local cover files before reading tags (faster)
- **NEW**: Caches metadata to eliminate repeated ID3 tag reads

### TagManager (`ci4/app/Libraries/TagManager.php`)
- **Purpose**: Read and write ID3v2 tags
- **Key Methods**:
  - `readTags($filePath)`: Read all tags from MP3 file
  - `writeTags($filePath, $tags)`: Write tags with preservation logic

**Tag Preservation**:
- **Genre**: Keeps existing genre if already set; only fills if empty
- **Cover Art**: NEVER overwrites existing cover art
- **Publisher**: Writes label from Discogs (new field)
- **Artist Cleaning**: Strips ` (2)`, ` (3)` suffixes from Discogs artist names

### DiscogsService (`ci4/app/Libraries/DiscogsService.php`)
- **Purpose**: Interface with Discogs API
- **Key Methods**:
  - `search($params)`: Multi-strategy search (folder name, album/artist)
  - `getRelease($id)`: Fetch full release metadata
  - `cleanArtistName($name)`: Remove numeric suffixes

**Search Strategies** (3 pools):
1. Folder name search
2. Album title + artist search
3. Album title only search

## API Endpoints

### Scan API (`/api/scan`)
- `GET /api/scan?action=list_dirs&path={path}`: List subdirectories
- `GET /api/scan?action=list_files&path={path}`: List albums in path (legacy)
- `GET /api/scan?action=list_files_with_metadata&path={path}&force={0|1}`: **NEW** List albums with metadata (artist, year, album) for hierarchical view
- `GET /api/scan?action=list_tracks&path={path}`: List tracks in album
- `GET /api/scan?action=get_cover&path={path}`: Get cover art (lazy loaded)

### Search API (`/api/search`)
- `GET /api/search?artist=X&album=Y&folder=Z`: Search Discogs (3 pools)
- `GET /api/search?action=get_release&id={id}&type={type}`: Get release details

### Tag API (`/api/tag`)
- `POST /api/tag`: Apply tags to multiple files
  - Body: `{files: [{path, album, artist, album_artist, title, year, genre, track, publisher}]}`
  - Returns: Array of status objects

## Frontend Architecture

### Single Page Application (`app.js`)
- **State Management**: Global `state` object tracks current path, albums, tracks, selected release
- **View Rendering**: Dynamic DOM manipulation
- **No Page Reloads**: All interactions via `fetch()` API calls

### UI Components
1. **Navbar**: Breadcrumbs, view toggles, force refresh button, theme toggle
2. **Hierarchical Album View** (NEW - Default):
   - Albums grouped by Album Artist with headers
   - Year badges on album covers (top-right corner)
   - Artists sorted alphabetically
   - Albums sorted by year (oldest first) within each artist
3. **Flat Album Grid**: Card-based layout with lazy-loaded covers (legacy, toggleable)
4. **Inline Detail View**: 
   - Left column: Local tracks table
   - Right column: Discogs search & comparison
5. **Smart View Toggle**: Merges related split releases

### View Modes (NEW)
- **Hierarchical View** (Default): MusicBee-style grouping by Album Artist → Year
- **Flat Grid View**: Original card grid layout
- **Toggle Button**: Green grid icon in navbar

### Smart Features
- **Hierarchical Grouping** (NEW): Automatic artist-based organization with year sorting
- **Metadata Caching** (NEW): Intelligent caching for instant subsequent loads
- **Split Release Grouping**: Detects "Split w/ Artist" patterns and merges them
- **Artist Name Cleaning**: Removes Discogs numeric suffixes automatically
- **Year Display** (NEW): Badges showing release year on album covers
- **Theme Toggle**: Dark (default) / Light mode with localStorage persistence

## Configuration

### Environment Variables (`.env`)
```env
MUSIC_ROOT_PATH="E:/#PATH/TO/YOUR/MUSIC"
DISCOGS_CONSUMER_KEY="your_discogs_key"
DISCOGS_CONSUMER_SECRET="your_discogs_secret"
```

### PHP Configuration
- **Memory Limit**: 512MB (`php.ini`)
  - Required for large libraries (800+ albums)
  - OOM errors when trying to load all cover art at once (hence lazy loading)
- **Required Extensions**:
  - `intl`: Required by CodeIgniter 4 for internationalization
  - `gd`: For image processing
  - Enable in `php.ini`: `extension=intl`

## Development Setup

### Installation
1. Clone repository: `git clone https://github.com/Angki/discogs_tagger.git`
2. Navigate to CI4 directory: `cd discogs_tagger/ci4`
3. Install Composer dependencies: `composer install --ignore-platform-reqs`
4. Create writable directory: `New-Item -Path "writable/cache", "writable/logs", "writable/session" -ItemType Directory -Force`
5. Copy `ci4/.env.example` to `ci4/.env`
6. Configure `MUSIC_ROOT_PATH` and Discogs API keys in `.env`
7. Enable PHP extensions in `php.ini`:
   - Uncomment or add: `extension=intl`
   - Ensure `extension=gd` is enabled
8. Verify PHP 8.1+ is installed

### Running Locally
```bash
# Option 1: Use batch script
start_server.bat

# Option 2: Manual (Recommended)
cd ci4
php spark serve --port=8080
```

Open browser to `http://localhost:8080`

### First-Time Setup Issues
If you encounter errors:
- **WRITEPATH error**: Create `ci4/writable` directory with subdirectories (cache, logs, session)
- **Composer error**: Run `composer install --ignore-platform-reqs`
- **Locale class error**: Enable `intl` extension in `php.ini`

### Testing
- `test_scan_recursion.php`: Standalone test for recursive scanning
- `test_api.php`: API endpoint verification

## Known Issues & Optimizations

### Memory Management
- **Issue**: 800+ albums with full cover art data causes OOM error
- **Solution**: Lazy loading via separate `get_cover` API endpoint
- **Trade-off**: More HTTP requests, but necessary for large libraries

### Cover Art Loading
- **Priority**: Local files (`cover.jpg`, `folder.jpg`) → Embedded tags
- **Rationale**: File I/O is faster than parsing MP3 tags
- **Browser Lazy Loading**: `loading="lazy"` attribute reduces initial load

### Performance
- **Recursive Scan**: ~1 second for 800 albums (without metadata)
- **Metadata Extraction** (NEW):
  - First load: 2-5 seconds (reads ID3 tags, builds cache)
  - Subsequent loads: <1 second (from cache)
  - Cache file: ~50-200KB for 800 albums
- **Cover Loading**: Instant for local files, ~50-100ms for tag extraction
- **Discogs API**: Rate limited, uses caching on browser side

## Data Flow

### Typical Usage Flow (Hierarchical View)
1. User opens app → `Home::index()` renders SPA
2. Frontend calls `/api/scan?action=list_files_with_metadata&path=` (NEW)
3. `FileScanner::getAlbumsWithMetadata()` checks cache:
   - **Cache hit**: Returns cached metadata instantly
   - **Cache miss**: Scans recursively, extracts metadata, saves cache
4. Frontend groups albums by artist, sorts by year
5. Browser renders hierarchical layout with artist headers and year badges
6. Browser lazy-loads covers via `/api/scan?action=get_cover&path={path}`
7. User clicks album → `/api/scan?action=list_tracks&path={path}`
8. User clicks "Smart Search" → `/api/search?artist=X&album=Y&folder=Z`
9. User selects release → `/api/search?action=get_release&id={id}`
10. User clicks "Apply Tags" → `POST /api/tag` with file array
11. `TagManager::writeTags()` writes tags with preservation logic

## Recent Updates

### v2.0 - MusicBee-Style Hierarchical UI (Feb 2026)
- ✅ Hierarchical album grouping by Album Artist
- ✅ Automatic year-based sorting within artist groups
- ✅ Year badges on album covers
- ✅ Intelligent metadata caching (`library_cache.json`)
- ✅ Toggle between hierarchical and flat grid views
- ✅ Force cache refresh functionality
- ✅ Improved performance for large libraries (800+ albums)

## Future Enhancements
- [ ] Batch tagging for multiple albums
- [ ] Undo/revert functionality
- [ ] Advanced search filters (year, label, country)
- [ ] Cover art editor (crop, replace)
- [ ] Support for FLAC, M4A formats
- [ ] Offline mode with cached Discogs data
- [ ] Group by Genre/Year (alternative to Artist grouping)
- [ ] Configurable cache location and expiry
- [ ] "Jump to Artist" quick navigation

## Credits
- **Discogs API**: https://www.discogs.com/developers
- **getID3**: https://github.com/JamesHeinrich/getID3
- **CodeIgniter 4**: https://codeigniter.com/
- **Bootstrap 5**: https://getbootstrap.com/
